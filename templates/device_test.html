{% extends "base.html" %}
{% load static %}

{% block title %}–¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞{% endblock %}

{% block content %}
    <div class="container my-5">
        <h2>–¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</h2>
        <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∞—à–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –¥–æ—Å—Ç—É–ø –±—Ä–∞—É–∑–µ—Ä—É.</p>

        <div class="row my-4">
            <div class="col-md-6">
                <h5>–ö–∞–º–µ—Ä–∞:</h5>
                <div id="cameraStatus" class="alert alert-secondary">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                <div id="videoContainer" style="display: none;">
                    <h5>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–º–µ—Ä—ã:</h5>
                    <video id="testVideo" width="100%" height="auto" autoplay playsinline muted
                           style="transform: scaleX(-1); border-radius: 8px; border: 1px solid #ccc;"></video>
                </div>
            </div>
            <div class="col-md-6">
                <h5>–ú–∏–∫—Ä–æ—Ñ–æ–Ω:</h5>
                <div id="microphoneStatus" class="alert alert-secondary">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
            </div>
            <div id="micVisualizer" class="mt-4"
                 style="height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; display: none;">
                <div id="micLevel" style="width: 100%; height: 100%;  background-color: #0d6efd;"></div>
            </div>
        </div>


    </div>
{% endblock %}

{% block extra_js %}
    <script>
        async function checkDevices() {
            const cameraStatus = document.getElementById('cameraStatus');
            const microphoneStatus = document.getElementById('microphoneStatus');
            const videoContainer = document.getElementById('videoContainer');
            const testVideo = document.getElementById('testVideo');
            const micVisualizer = document.getElementById('micVisualizer');
            const micLevel = document.getElementById('micLevel');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                testVideo.srcObject = stream;
                videoContainer.style.display = 'block';
                micVisualizer.style.display = 'block';

                const devices = await navigator.mediaDevices.enumerateDevices();
                const hasCamera = devices.some(device => device.kind === 'videoinput');
                const hasMicrophone = devices.some(device => device.kind === 'audioinput');

                cameraStatus.className = hasCamera ? 'alert alert-success' : 'alert alert-danger';
                cameraStatus.textContent = hasCamera ? '–ö–∞–º–µ—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω' : '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';

                microphoneStatus.className = hasMicrophone ? 'alert alert-success' : 'alert alert-danger';
                microphoneStatus.textContent = hasMicrophone ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞–π–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';

                // üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ AudioContext
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioSource = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                audioSource.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function updateMicLevel() {
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / dataArray.length;
                    micLevel.style.width = `${Math.min(100, average)}%`;

                    requestAnimationFrame(updateMicLevel);
                }

                updateMicLevel();

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', err);

                cameraStatus.className = 'alert alert-danger';
                cameraStatus.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –∫–∞–º–µ—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';

                microphoneStatus.className = 'alert alert-danger';
                microphoneStatus.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            }
        }

        document.addEventListener('DOMContentLoaded', checkDevices);
    </script>
{% endblock %}
