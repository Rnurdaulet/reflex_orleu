{% load static %}
<h2>Анкета</h2>
<form method="post" action="{% url 'survey_submit' %}" id="survey-form">
    {% csrf_token %}
    <input type="text" name="external_id" placeholder="Внешний ID" required><br>
<input type="text" name="full_name" placeholder="ФИО (только латиница)" oninput="filterLatinField(this)" required><br>

    <select name="gender" required>
        <option value="">Выберите пол</option>
        <option value="male">Мужской</option>
        <option value="female">Женский</option>
    </select><br>
    <input type="number" name="age" placeholder="Возраст" required><br>

    <hr>

    {% for i in "12345" %}
        <label>Ответ на вопрос {{ i }}:</label><br>
        <textarea id="answer_{{ i }}" name="answer_{{ i }}" oninput="filterLatinAndCount(this, {{ i }})"
                  required></textarea>
        <div id="counter_{{ i }}">Слов: 0</div>
        <div id="latin_warn_{{ i }}" class="latin-warning" style="color: red; font-size: 0.9em; display: none;">
            Допустимы только латинские символы.
        </div>
        <br>
    {% endfor %}


    <hr>
    <div id="total_counter" style="font-weight: bold;">Общий счёт: 0 / 1500 слов</div>
    <button type="submit" id="submit-button">Сохранить и просмотреть</button>

</form>

<!-- Подключаем Countable.js -->
<script src="{% static 'js/Countable.js' %}"></script>
<style>
    .latin-warning {
        margin-top: -5px;
        margin-bottom: 10px;
        display: none;
    }
</style>

<script>
    const fields = [1, 2, 3, 4, 5];
    let totalWords = 0;
    let allFieldsValid = true;

    function countWords(text) {
        return text.trim().split(/\s+/).filter(Boolean).length;
    }

    function filterLatinField(el) {
        const isLatin = /^[\x00-\x7F]*$/.test(el.value);
        if (!isLatin) {
            el.style.borderColor = "red";
        } else {
            el.style.borderColor = "";
        }
    }


    function filterLatinAndCount(el, index) {
        const value = el.value;
        const isLatin = /^[\x00-\x7F]*$/.test(value);

        // Обновить предупреждение
        const warn = document.getElementById(`latin_warn_${index}`);
        if (!isLatin) {
            warn.style.display = "block";
            el.style.borderColor = "red";
        } else {
            warn.style.display = "none";
            el.style.borderColor = "";
        }

        // Обновить счётчик слов
        const wordCount = countWords(value);
        document.getElementById(`counter_${index}`).innerText = `Слов: ${wordCount}`;

        // Обновить общий счёт
        validateTotal();
    }

    function validateTotal() {
        totalWords = 0;
        allFieldsValid = true;

        fields.forEach(i => {
            const el = document.getElementById(`answer_${i}`);
            const value = el.value;
            const isLatin = /^[\x00-\x7F]*$/.test(value);
            const words = countWords(value);
            totalWords += words;

            if (!isLatin) {
                allFieldsValid = false;
            }
        });

        const totalEl = document.getElementById("total_counter");
        const isValidTotal = totalWords <= 1500 && allFieldsValid;
        totalEl.innerText = `Общий счёт: ${totalWords} / максимум 1500 слов`;
        totalEl.style.color = isValidTotal ? "green" : "red";
        document.getElementById("submit-button").disabled = !isValidTotal;


    }

    document.addEventListener("DOMContentLoaded", () => {
        validateTotal();
    });
</script>
