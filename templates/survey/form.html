{% extends "base.html" %}
{% load static %}
{% block title %}–ê–Ω–∫–µ—Ç–∞{% endblock %}

{% block content %}
    <h2 class="mb-4">–ê–Ω–∫–µ—Ç–∞</h2>
    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ -->
        <div class="col-lg-8">
            <form method="post" action="{% url 'survey_submit' %}" id="survey-form" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="row">


                    <!-- –§–ò–û -->
                    <div class="col-12 col-md-12">
                        <label for="full_name" class="form-label">–§–ò–û (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                        <input type="text" name="full_name" id="full_name" class="form-control"
                               oninput="filterLatinField(this)" required>
                    </div>
                    <!-- –í–Ω–µ—à–Ω–∏–π ID -->
                    <div class="col-12 col-md-4">
                        <label for="external_id" class="form-label">–í–Ω–µ—à–Ω–∏–π ID</label>
                        <input type="text" name="external_id" id="external_id" class="form-control"
                                required>
                    </div>

                    <!-- –ü–æ–ª -->
                    <div class="col-6 col-md-4">
                        <label for="gender" class="form-label">–ü–æ–ª</label>
                        <select name="gender" id="gender" class="form-select" required>
                            <option value="">‚Äî</option>
                            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>

                    <!-- –í–æ–∑—Ä–∞—Å—Ç -->
                    <div class="col-6 col-md-4">
                        <label for="age" class="form-label">–í–æ–∑—Ä–∞—Å—Ç</label>
                        <input type="number" name="age" id="age" class="form-control" required>
                    </div>
                </div>


                <hr class="my-4">

                {% for i in "12345" %}
                    <div class="mb-3">
                        <label for="answer_{{ i }}" class="form-label">–û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å {{ i }}</label>
                        <textarea id="answer_{{ i }}" name="answer_{{ i }}" class="form-control" rows="3"
                                  oninput="filterLatinAndCount(this, {{ i }})" required></textarea>
                        <div id="counter_form_{{ i }}" class="form-text">–°–ª–æ–≤: 0</div>

                        <div id="latin_warn_{{ i }}" class="form-text text-danger latin-warning" style="display: none;">
                            –î–æ–ø—É—Å—Ç–∏–º—ã —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã.
                        </div>
                    </div>
                {% endfor %}
            </form>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                    <ul class="list-group list-group-flush mb-3">
                        {% for i in "12345" %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                –í–æ–ø—Ä–æ—Å {{ i }}
                                <span id="counter_card_{{ i }}" class="badge bg-secondary">0 —Å–ª–æ–≤</span>

                            </li>
                        {% endfor %}
                    </ul>
                    <hr>
                    <p id="total_counter" class="fw-bold text-danger">–û–±—â–∏–π —Å—á—ë—Ç: 0 / –º–∞–∫—Å–∏–º—É–º 1500 —Å–ª–æ–≤</p>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" id="progress-bar" role="progressbar" style="width: 0%">
                            0%
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" form="survey-form" id="submit-button" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏
                            –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Countable -->
    <script src="{% static 'js/Countable.js' %}"></script>

    <style>
        .latin-warning {
            font-size: 0.875em;
        }
    </style>

    <script>
        const fields = [1, 2, 3, 4, 5];
        let totalWords = 0;
        let allFieldsValid = true;

        function countWords(text) {
            return text.trim().split(/\s+/).filter(Boolean).length;
        }

        function filterLatinField(el) {
            const isLatin = /^[\x00-\x7F]*$/.test(el.value);
            el.classList.toggle("is-invalid", !isLatin);
        }

        function filterLatinAndCount(el, index) {
            const value = el.value;
            const isLatin = /^[\x00-\x7F]*$/.test(value);

            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            const warn = document.getElementById(`latin_warn_${index}`);
            warn.style.display = isLatin ? "none" : "block";
            el.classList.toggle("is-invalid", !isLatin);

            // –°–ª–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É
            const wordCount = countWords(value);

            // –û–±–Ω–æ–≤–∏–º –æ–±–∞ —Å—á—ë—Ç—á–∏–∫–∞:
            document.getElementById(`counter_form_${index}`).innerText = `–°–ª–æ–≤: ${wordCount}`;
            document.getElementById(`counter_card_${index}`).innerText = `${wordCount} —Å–ª–æ–≤`;

            validateTotal();
        }


        function validateTotal() {
            totalWords = 0;
            allFieldsValid = true;

            fields.forEach(i => {
                const el = document.getElementById(`answer_${i}`);
                const isLatin = /^[\x00-\x7F]*$/.test(el.value);
                const words = countWords(el.value);
                totalWords += words;
                if (!isLatin) allFieldsValid = false;
            });

            const totalEl = document.getElementById("total_counter");
            const isValidTotal = totalWords <= 1500 && allFieldsValid;
            totalEl.innerText = `–û–±—â–∏–π —Å—á—ë—Ç: ${totalWords} / –º–∞–∫—Å–∏–º—É–º 1500 —Å–ª–æ–≤`;
            totalEl.classList.toggle("text-danger", !isValidTotal);
            totalEl.classList.toggle("text-success", isValidTotal);
            document.getElementById("submit-button").disabled = !isValidTotal;

            // üü¢ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            const progress = Math.min(100, Math.round((totalWords / 1500) * 100));
            const progressBar = document.getElementById("progress-bar");
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
        }

        document.addEventListener("DOMContentLoaded", () => {
            validateTotal();
        });
    </script>
{% endblock %}
