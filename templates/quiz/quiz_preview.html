{% extends "base.html" %}
{% load static %}
{% block title %}Preview Your Quiz{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'assets/css/atom-one-dark.min.css' %}"><!-- –ø—Ä–∏–º–µ—Ä -->
    <style>
        .container {
            max-width: 800px;
            margin: 2rem auto;
        }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, .075);
        }

        .lang-ru, .lang-kk, .lang-en {
            display: none;
        }

        .lang-ru.active, .lang-kk.active, .lang-en.active {
            display: inline;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title mb-3">üîç Preview Your Quiz</h2>

                <!-- Personal Info -->
                {% if quiz_person %}
                    <ul class="list-group list-group-flush mb-4">
                        <li class="list-group-item"><strong>Full
                            Name:</strong> {{ quiz_person.firstname }} {{ quiz_person.lastname }}</li>
                        <li class="list-group-item"><strong>Gender:</strong> {{ quiz_person.get_gender_display }}</li>
                        <li class="list-group-item"><strong>Age:</strong> {{ quiz_person.age }}</li>
                        <li class="list-group-item"><strong>Experience:</strong> {{ quiz_person.years_experience }}
                            years
                        </li>
                    </ul>
                {% endif %}

                <hr>

                <!-- Answers by Scenario -->
                {% for block in preview %}
                    <div class="mb-4">
                        <h5>{{ forloop.counter }}. {{ block.scenario.name_ru }}</h5>
                        <ul class="list-group">
                            {% for it in block.items %}
                                <li class="list-group-item">
                                    <strong>{{ forloop.counter }}) </strong>{{ it.question }}<br>
                                    <em>Your answer:</em> {{ it.answer }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endfor %}


                {% if remaining_seconds %}
                    <div class="alert alert-info">
                        –û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: <span id="time-remaining">{{ remaining_seconds }}</span> —Å–µ–∫.
                    </div>
                    <script>
                        (function () {
                            let remaining = parseInt(document.getElementById('time-remaining').textContent, 10);
                            const el = document.getElementById('time-remaining');

                            function update() {
                                if (remaining > 0) {
                                    remaining -= 1;
                                    el.textContent = remaining;
                                    setTimeout(update, 1000);
                                }
                            }

                            update();
                        })();
                    </script>
                {% endif %}

                {% if not quiz_person.signature %}
                    <!-- Sign & Submit -->
                    <form id="sign-form" method="post" action="{% url 'quiz_sign' %}">
                        {% csrf_token %}
                        <button type="button" class="btn btn-success btn-lg" onclick="signQuiz()">
                            <span class="lang-ru active">–ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                            <span class="lang-kk">“ö–æ–ª “õ–æ–π—ã–ø –∂—ñ–±–µ—Ä—É</span>
                            <span class="lang-en">Sign & Submit</span>
                        </button>
                    </form>
                    <p class="mt-3 text-muted" id="status">Awaiting signature...</p>

                        {% if remaining_seconds == 0 %}
                            <div class="alert alert-warning">
                                –í—Ä–µ–º—è –≤—ã—à–ª–æ. –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã, —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å.
                            </div>
                        {% else %}
                            <a href="{% url 'quiz_take' %}" class="btn btn-warning">–í–µ—Ä–Ω—É—Ç—å—Å—è –∏ –∏–∑–º–µ–Ω–∏—Ç—å</a>
                        {% endif %}


                {% else %}
                    <div class="alert alert-success">–û—Ç–≤–µ—Ç—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã. –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã.</div>
                {% endif %}

            </div>
        </div>
    </div>
    <!-- Modal for messages -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageModalLabel">–°–æ–æ–±—â–µ–Ω–∏–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">–û–∫</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/ncalayer-client.js' %}"></script>
    <script>
        function btoaUtf8(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        async function signQuiz() {
            const previewText = `{{ preview_json|escapejs }}`;
            const documentBase64 = btoaUtf8(previewText);
            const client = new NCALayerClient();
            try {
                await client.connect();
                let sig = await client.basicsSignCMS(
                    NCALayerClient.basicsStorageAll,
                    documentBase64,
                    NCALayerClient.basicsCMSParamsDetached,
                    NCALayerClient.basicsSignerSignAny
                );
                // –û—á–∏—â–∞–µ–º PEM-–∑–∞–≥–æ–ª–æ–≤–∫–∏
                if (sig.includes('-----BEGIN CMS-----')) {
                    sig = sig
                        .replace('-----BEGIN CMS-----', '')
                        .replace('-----END CMS-----', '')
                        .replace(/\r?\n|\r/g, '')
                        .trim();
                }
                const form = new FormData();
                form.append('signature', sig);
                const resp = await fetch("{% url 'quiz_sign' %}", {
                    method: 'POST',
                    body: form
                });
                const result = await resp.json();

                // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –º–æ–¥–∞–ª–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                const modalEl = document.getElementById('messageModal');
                modalEl.querySelector('.modal-body').textContent = result.message;
                new bootstrap.Modal(modalEl).show();

                if (result.success) {
                    // –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–º –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
                    modalEl.addEventListener('hidden.bs.modal', () => {
                        window.location.href = "{% url 'quiz_submitted' %}";
                    }, {once: true});
                }
            } catch (err) {
                const modalEl = document.getElementById('messageModal');
                modalEl.querySelector('.modal-body').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏: ' + err;
                new bootstrap.Modal(modalEl).show();
            }
        }

    </script>
{% endblock %}
