{% extends "base.html" %}
{% load static %}
{% block title %}{{ config.title }}{% endblock %}
{% load dict_filters %}

{% block extra_css %}
    <style>
        html {
            scroll-padding-top: 6rem;
        }

        section[id] {
            scroll-margin-top: 6rem;
        }

        #sidebar {
            position: sticky;
            top: 6rem;
            max-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .timer {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .quiz-page {
            display: none;
        }

        .quiz-page.active {
            display: block;
        }

        /* –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è */
        .lang-ru, .lang-kk, .lang-en {
            display: none;
        }

        .lang-ru.active, .lang-kk.active, .lang-en.active {
            display: inline;
        }

        iframe {
            width: 320px;
            height: 240px;
            border: none;
            margin-top: 1rem;
        }
    </style>
    <style>
        #proctorWrapper {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 340px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 12px;
            z-index: 9999;
            font-family: monospace;
            color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #proctorWrapper iframe {
            width: 100%;
            height: 240px;
            border: none;
            border-radius: 6px;
        }

        #proctorWrapper button {
            margin-top: 5px;
            width: 100%;
            padding: 0px;
            font-weight: bold;
        }

        #output {
            display: none;
        }
    </style>

{% endblock %}

{% block content %}
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <main class="col-lg-9">
            <div class="d-flex justify-content-between">
                <!-- –ò–Ω—Ñ–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                {% if quiz_person %}
                    <div class="justify-content-start align-content-center">
                        <strong>{{ quiz_person.firstname }} {{ quiz_person.lastname }}</strong><br>
                        {{ quiz_person.external_id }}
                    </div>
                {% endif %}
                <strong class="justify-content-end align-content-center" id="time">--:--</strong>
                <!-- Language dropdown -->
                <div class="dropdown justify-content-end align-content-center">
                    <button class="btn btn-secondary dropdown-toggle" type="button"
                            id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">–†—É—Å—Å–∫–∏–π
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="langDropdown">
                        <li><a class="dropdown-item lang-switch active" data-lang="ru" href="#">–†—É—Å—Å–∫–∏–π</a></li>
                        <li><a class="dropdown-item lang-switch" data-lang="kk" href="#">“ö–∞–∑–∞“õ—à–∞</a></li>
                        <li><a class="dropdown-item lang-switch" data-lang="en" href="#">English</a></li>
                    </ul>
                </div>
            </div>
            <form id="quiz-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="logs" id="logs-input">
                <div id="pages">
                    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 0: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
                    <div class="quiz-page active" data-step="0">
                        <h2>
                            <span class="lang-ru active">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</span>
                            <span class="lang-kk">“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!</span>
                            <span class="lang-en">Welcome!</span>
                        </h2>
                        <p>
                            <span class="lang-ru active">–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º:</span>
                            <span class="lang-kk">–¢–µ—Å—Ç—ñ –±–∞—Å—Ç–∞–º–∞—Å –±“±—Ä—ã–Ω –Ω“±—Å“õ–∞—É–ª—ã“õ—Ç—ã –æ“õ—ã“£—ã–∑:</span>
                            <span class="lang-en">Please read the instructions before starting:</span>
                        </p>
                        <ul>
                            <li>
                                <span class="lang-ru active">–¢–µ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç {{ scenarios|length }} —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.</span>
                                <span class="lang-kk">{{ scenarios|length }} —Å—Ü–µ–Ω–∞—Ä–∏–π–¥–µ–Ω —Ç“±—Ä–∞–¥—ã.</span>
                                <span class="lang-en">The test has {{ scenarios|length }} scenarios.</span>
                            </li>
                            <li>
                                <span class="lang-ru active">–ù–∞ –≤–µ—Å—å —Ç–µ—Å—Ç –æ—Ç–≤–æ–¥–∏—Ç—Å—è {{ config.test_duration_minutes }} –º–∏–Ω—É—Ç.</span>
                                <span class="lang-kk">–ë“Ø–∫—ñ–ª —Ç–µ—Å—Ç–∫–µ {{ config.test_duration_minutes }} –º–∏–Ω—É—Ç –±–µ—Ä—ñ–ª–µ–¥—ñ.</span>
                                <span class="lang-en">You have {{ config.test_duration_minutes }} minutes to complete the entire test.</span>
                            </li>
                            <li>
                                <span class="lang-ru active">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∑–∞ 15 —Å–µ–∫—É–Ω–¥ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.</span>
                                <span class="lang-kk">–£–∞“õ—ã—Ç –±—ñ—Ç—É–≥–µ 15 —Å–µ–∫—É–Ω–¥ “õ–∞–ª“ì–∞–Ω–¥–∞ –∂–∞—É–∞–ø—Ç–∞—Ä –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂—ñ–±–µ—Ä—ñ–ª–µ–¥—ñ.</span>
                                <span class="lang-en">Answers will be automatically submitted 15 seconds before the time is up.</span>
                            </li>
                            <li>
                                <span class="lang-ru active">–ù–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî —á–µ—Ä–µ–∑ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å.</span>
                                <span class="lang-kk">–ù–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî —Å–æ–ª –∂–∞“õ –ø–∞–Ω–µ–ª—å –∞—Ä“õ—ã–ª—ã.</span>
                                <span class="lang-en">Use the sidebar to navigate.</span>
                            </li>
                        </ul>

                        <button type="button" class="btn btn-primary" id="start-btn">
                            <span class="lang-ru active">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</span>
                            <span class="lang-kk">–¢–µ—Å—Ç—ñ –±–∞—Å—Ç–∞—É</span>
                            <span class="lang-en">Start Test</span>
                        </button>
                    </div>

                    <!-- –ü–æ –æ–¥–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É -->
                    {% for scenario in scenarios %}
                        <div class="quiz-page" data-step="{{ forloop.counter }}">
                            <h3>
                                <span class="lang-ru active">{{ scenario.name_ru }}</span>
                                <span class="lang-kk">{{ scenario.name_kk }}</span>
                                <span class="lang-en">{{ scenario.name_en }}</span>
                            </h3>
                            <p class="fst-italic">
                                <span class="lang-ru active">{{ scenario.situation_ru }}</span>
                                <span class="lang-kk">{{ scenario.situation_kk }}</span>
                                <span class="lang-en">{{ scenario.situation_en }}</span>
                            </p>

                            {% for q in scenario.questions.all %}
                                <div class="mb-3">
                                    <h5>
                                        {{ forloop.parentloop.counter }}.{{ forloop.counter }}
                                        <span class="lang-ru active">{{ q.name_ru }}</span>
                                        <span class="lang-kk">{{ q.name_kk }}</span>
                                        <span class="lang-en">{{ q.name_en }}</span>
                                    </h5>
                                    {% for a in q.answers.all %}
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="question_{{ q.id }}"
                                                   id="q{{ q.id }}a{{ forloop.counter }}"
                                                   value="{{ a.id }}"
                                                   data-scenario-id="{{ scenario.id }}"
                                                   {% if selected_answers|get_item:q.id == a.id %}checked{% endif %}>


                                            <label class="form-check-label" for="q{{ q.id }}a{{ forloop.counter }}">
                                                <span class="lang-ru active">{{ a.name_ru }}</span>
                                                <span class="lang-kk">{{ a.name_kk }}</span>
                                                <span class="lang-en">{{ a.name_en }}</span>
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}

                            <div class="d-flex justify-content-between">
                                {% if not forloop.first %}
                                    <button type="button" class="btn btn-secondary prev-btn">
                                        <span class="lang-ru active">–ù–∞–∑–∞–¥</span>
                                        <span class="lang-kk">–ê—Ä—Ç“õ–∞</span>
                                        <span class="lang-en">Back</span>
                                    </button>
                                {% else %}<span></span>{% endif %}
                                {% if not forloop.last %}
                                    <button type="button" class="btn btn-primary next-btn">
                                        <span class="lang-ru active">–î–∞–ª–µ–µ</span>
                                        <span class="lang-kk">–ö–µ–ª–µ—Å—ñ</span>
                                        <span class="lang-en">Next</span>
                                    </button>
                                {% else %}
                                    <button type="button"
                                            class="btn btn-success"
                                            id="open-confirmation-modal">
                                        <span class="lang-ru active">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                                        <span class="lang-kk">–ñ—ñ–±–µ—Ä—É</span>
                                        <span class="lang-en">Submit</span>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>


            </form>
        </main>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="col-lg-3 mb-4">
            <nav id="sidebar" class="list-group">
                <div class="">
                    <iframe
                            id="proctorFrame"
                            src="{% static '/proctoring.html' %}"
                            allow="camera; microphone">
                    </iframe>
                    <canvas id="output" width="280" height="240"></canvas>
                </div>
                <a href="#" class="list-group-item list-group-item-action" data-step="0">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</a>
                {% for scenario in scenarios %}
                    <a href="#" class="list-group-item list-group-item-action" data-step="{{ forloop.counter }}">
                        <span class="lang-ru active">{{ scenario.name_ru }}</span>
                        <span class="lang-kk">{{ scenario.name_kk }}</span>
                        <span class="lang-en">{{ scenario.name_en }}</span>
                        <div class="progress mt-1">
                            <div class="progress-bar"
                                 role="progressbar"
                                 id="progress-bar-{{ scenario.id }}"
                                 data-scenario-id="{{ scenario.id }}"
                                 data-total="{{ scenario.questions.count }}"
                                 style="width:0%">
                                0/{{ scenario.questions.count }}
                            </div>
                        </div>
                    </a>
                {% endfor %}
            </nav>

        </aside>
    </div>
    {#    <div id="proctorWrapper">#}
    {#        <iframe#}
    {#                id="proctorFrame"#}
    {#                src="{% static '/proctoring.html' %}"#}
    {#                allow="camera; microphone">#}
    {#        </iframe>#}
    {#        <canvas id="output" width="280" height="240"></canvas>#}
    {#    </div>#}

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">
                        <span class="lang-ru active">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É</span>
                        <span class="lang-kk">–ñ—ñ–±–µ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞“£—ã–∑</span>
                        <span class="lang-en">Confirm Submission</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        <span class="lang-ru active">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–∞—Ç—å —Ç–µ—Å—Ç? </span>
                        <span class="lang-kk">–°—ã–Ω–∞“õ —Ç–∞–ø—Å—ã—Ä–º–∞—Å—ã–Ω –∂—ñ–±–µ—Ä–≥—ñ“£—ñ–∑ –∫–µ–ª–µ—Ç—ñ–Ω–¥—ñ–≥—ñ“£—ñ–∑–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? </span>
                        <span class="lang-en">Are you sure you want to submit the test?</span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        <span class="lang-ru active">–û—Ç–º–µ–Ω–∞</span>
                        <span class="lang-kk">–ë–∞—Å —Ç–∞—Ä—Ç—É</span>
                        <span class="lang-en">Cancel</span>
                    </button>
                    <button type="button"
                            class="btn btn-primary"
                            id="confirm-submit">
                        <span class="lang-ru active">–î–∞, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                        <span class="lang-kk">–ò”ô, –∂—ñ–±–µ—Ä—É</span>
                        <span class="lang-en">Yes, submit</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Toast markup -->
    <div class="toast-container position-fixed top-50 start-50 translate-middle p-3">
        <div class="toast border-danger" id="violationToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fi-alert-circle text-danger fs-base mt-1 me-2"></i>
                <strong class="me-auto">–ù–∞—Ä—É—à–µ–Ω–∏–µ!</strong>
                <button type="button" class="btn-close ms-2" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}


    <script>
        (function () {
            'use strict';

            const LOG_KEY = 'quizViolationsLog';  // –∫–ª—é—á –≤ localStorage
            if (localStorage.getItem('quizViolationsLog')) {
                localStorage.removeItem('quizViolationsLog');
            }
            let logs = loadLogs();                // —Ç–µ–∫—É—â–∏–π –º–∞—Å—Å–∏–≤ –ª–æ–≥–æ–≤

            // --- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage ---
            function loadLogs() {
                try {
                    const raw = localStorage.getItem(LOG_KEY);
                    return raw ? JSON.parse(raw) : [];
                } catch {
                    return [];
                }
            }

            function saveLogs() {
                localStorage.setItem(LOG_KEY, JSON.stringify(logs));
            }

            window.logEvent = function (type, detail = '') {
                const entry = {
                    event: type,
                    detail: detail,
                    timestamp: new Date().toISOString()
                };
                logs.push(entry);
                saveLogs();
                console.debug('Logged:', entry);
            };

            // --- –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
            logEvent('page_opened');

            // --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Bootstrap-toast) ---
            const toastEl = document.getElementById('violationToast');
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl);

            window.showViolation = function (msg) {
                toastEl.querySelector('.toast-body').textContent = msg;
                toast.show();
                logEvent('violation', msg);
            };


            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π ---
            // 1) –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                showViolation('–ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –∑–∞–ø—Ä–µ—â—ë–Ω');
            });

            // 2) –ö–ª–∞–≤–∏—à–∏: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, DevTools, –ø—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            {#document.addEventListener('keydown', e => {#}
            {#    const k = e.key;#}
            {#    const forbidden = k === 'F12'#}
            {#    if (forbidden) {#}
            {#        e.preventDefault();#}
            {#        showViolation('DevTools –∑–∞–ø—Ä–µ—â–µ–Ω—ã');#}
            {#    }});#}

            // 3) –°–º–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∏
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    showViolation('–ü–æ–∫–∏–¥–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ –Ω–µ–ª—å–∑—è');
                }
            });
            window.addEventListener('resize', () => {
                showViolation('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–æ');
            });
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–∞
            document.addEventListener('copy', e => {
                e.preventDefault();
                showViolation('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ');
            });
            document.addEventListener('cut', e => {
                e.preventDefault();
                showViolation('–í—ã—Ä–µ–∑–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ');
            });
            document.addEventListener('paste', e => {
                e.preventDefault();
                showViolation('–í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞');
            });
            document.addEventListener('keydown', e => {
                const mod = e.ctrlKey || e.metaKey;
                if (mod && e.key.toLowerCase() === 'p') {
                    e.preventDefault();
                    showViolation('–ü–µ—á–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–ø—Ä–µ—â–µ–Ω–∞');
                }
            });
            window.addEventListener('beforeprint', e => {
                e.preventDefault();
                showViolation('–ü–µ—á–∞—Ç—å —ç–∫—Ä–∞–Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞');
            });
            window.addEventListener('offline', () => showViolation('–ù–µ—Ç —Å–µ—Ç–∏ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–æ'));
            window.addEventListener('online', () => logEvent('online', '–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'));

            window.addEventListener('blur', () => showViolation('–ü–æ–∫–∏–¥–∞—Ç—å –æ–∫–Ω–æ —Ç–µ—Å—Ç–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–æ'));
            window.addEventListener('focus', () => logEvent('focus', '–í–µ—Ä–Ω—É–ª–∏—Å—å –≤ –æ–∫–Ω–æ'));


            // --- –î–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –≤ –∫–æ–Ω—Å–æ–ª–∏ ---
            window.getViolationLogs = () => loadLogs();

        })();

        document.addEventListener('DOMContentLoaded', function () {

            // –ø–æ –∫–ª–∏–∫—É ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            document.getElementById('open-confirmation-modal')
                .addEventListener('click', function () {
                    var modal = new bootstrap.Modal(
                        document.getElementById('confirmationModal')
                    );
                    modal.show();
                });

            // –ø–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é ‚Äî —Å–∞–±–º–∏—Ç–∏–º —Ñ–æ—Ä–º—É
            document.getElementById('confirm-submit')
                .addEventListener('click', function () {
                    document.getElementById('logs-input').value = localStorage.getItem('quizViolationsLog') || '[]';
                    document.getElementById('quiz-form').submit();
                });
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º hash
            if (location.hash) {
                history.replaceState(null, '', location.pathname + '#0');
                window.scrollTo(0, 0);
            }

            // –¢–∞–π–º–µ—Ä
            let remaining = {{ remaining_seconds }},
                disp = document.getElementById('time');

            function fmt(t) {
                let m = Math.floor(t / 60), s = t % 60;
                return m + ':' + (s < 10 ? '0' + s : s);
            }

            disp.textContent = fmt(remaining);
            setInterval(function () {
                if (--remaining <= 15) {
                    logEvent('auto_submit_10s_left', '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞ 15 —Å–µ–∫—É–Ω–¥ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                    showViolation('–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å 15 —Å–µ–∫—É–Ω–¥. –û—Ç–≤–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
                    // –î–æ–±–∞–≤–∏–º –ª–æ–≥–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏–º
                    setTimeout(() => {
                        document.getElementById('logs-input').value = localStorage.getItem('quizViolationsLog') || '[]';
                        document.getElementById('quiz-form').submit();
                    }, 1500); // —á—É—Ç—å –ø–æ–¥–æ–∂–¥—ë–º, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç
                } else disp.textContent = fmt(remaining);
            }, 1000);

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const pages = Array.from(document.querySelectorAll('.quiz-page'));
            let current = 0;

            function showPage(i) {
                if (i < 0 || i >= pages.length) return;
                pages[current].classList.remove('active');
                pages[i].classList.add('active');
                current = i;
            }

            document.getElementById('start-btn').addEventListener('click', () => showPage(1));
            document.querySelectorAll('.next-btn').forEach(btn =>
                btn.addEventListener('click', () => showPage(current + 1))
            );
            document.querySelectorAll('.prev-btn').forEach(btn =>
                btn.addEventListener('click', () => showPage(current - 1))
            );
            document.querySelectorAll('#sidebar .list-group-item').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const step = parseInt(this.dataset.step, 10);
                    if (!isNaN(step)) showPage(step);
                });
            });

            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            const bars = {};
            document.querySelectorAll('.progress-bar[data-scenario-id]').forEach(el => {
                bars[el.dataset.scenarioId] = {bar: el, total: +el.dataset.total};
            });
            document.querySelectorAll('input[type=radio][data-scenario-id]').forEach(radio => {
                radio.addEventListener('change', e => {
                    const sid = e.target.dataset.scenarioId;
                    const answered = document.querySelectorAll(
                        `input[type=radio][data-scenario-id="${sid}"]:checked`
                    ).length;
                    const obj = bars[sid];
                    const pct = obj.total ? Math.round(answered / obj.total * 100) : 0;
                    obj.bar.style.width = pct + '%';
                    obj.bar.setAttribute('aria-valuenow', pct);
                    obj.bar.textContent = answered + '/' + obj.total;
                });
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞
            document.querySelectorAll('.lang-switch').forEach(a => {
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    const lang = this.dataset.lang;
                    // –û–±–Ω–æ–≤–ª—è–µ–º dropdown label
                    document.getElementById('langDropdown').textContent = this.textContent;
                    // –ê–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç
                    document.querySelectorAll('.lang-switch').forEach(x => x.classList.remove('active'));
                    this.classList.add('active');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∞–Ω—ã
                    ['ru', 'kk', 'en'].forEach(l => {
                        document.querySelectorAll('.lang-' + l).forEach(el => {
                            el.classList.toggle('active', l === lang);
                        });
                    });
                });
            });
        });
    </script>
    <script>
        let mediaRecorder, chunks = [], drawId;
        let canvas = document.getElementById('output');
        let ctx = canvas.getContext('2d');
        let chunkInterval;
        let isRecording = false;

        let chunkIndex = 0;

        async function uploadChunk(blob) {
            const res = await fetch(`/api/get-presigned-url/?index=${chunkIndex}`);
            const {url, key} = await res.json();

            await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'video/webm'
                },
                body: blob
            });

            console.log(`‚òÅÔ∏è –ó–∞–ª–∏—Ç —á–∞–Ω–∫ #${chunkIndex} –≤ ${key}`);
            chunkIndex++;
        }

        async function startRecording() {
            const iframe = document.getElementById('proctorFrame');
            const iframeDoc = iframe.contentWindow.document;

            const video = iframeDoc.getElementById('video');
            const log = iframeDoc.getElementById('log');
            const checklist = iframeDoc.getElementById('checklist');

            if (!video) {
                console.warn("‚ö†Ô∏è –í–∏–¥–µ–æ –≤–Ω—É—Ç—Ä–∏ iframe –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                return;
            }

            const audioStream = await navigator.mediaDevices.getUserMedia({audio: true});

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                ctx.font = "9px monospace";
                ctx.fillStyle = "rgba(0,0,0,0.6)";
                ctx.fillRect(0, 0, 320, 40);
                ctx.fillStyle = "lime";
                ctx.fillText(log?.textContent || '', 10, 15);

                ctx.fillStyle = "yellow";
                const lines = (checklist?.textContent || '').split("<br>");
                lines.forEach((line, i) => {
                    ctx.fillText(line, 10, 30 + i * 15);
                });

                drawId = requestAnimationFrame(draw);
            }

            draw();

            const videoStream = canvas.captureStream(10);
            const combinedStream = new MediaStream([
                ...videoStream.getVideoTracks(),
                ...audioStream.getAudioTracks()
            ]);

            mediaRecorder = new MediaRecorder(combinedStream, {mimeType: 'video/webm'});

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    console.log(`üíæ –ß–∞–Ω–∫ #${chunkIndex} ‚Üí ${Math.round(e.data.size / 1024)} KB`);
                    uploadChunk(e.data).catch(err => {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞–Ω–∫–∞:", err);
                    });
                }

            };

            mediaRecorder.onstop = () => {
                cancelAnimationFrame(drawId);
                clearInterval(chunkInterval);
                isRecording = false;
                console.log("üõë –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");

                if (chunks.length > 0) {
                    const blob = new Blob(chunks, {type: 'video/webm'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `recording_${Date.now()}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            };

            mediaRecorder.start(20000); // –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫
            isRecording = true;
            console.log("üî¥ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å");
        }

        // üõë –ï—Å–ª–∏ —É—Ö–æ–¥–∏—Ç ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º!
        window.addEventListener('beforeunload', (e) => {
            if (isRecording) {
                e.preventDefault();
                e.returnValue = '';
                console.log("‚ö†Ô∏è beforeunload: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å");

                mediaRecorder.requestData();
                mediaRecorder.stop(); // –≤—ã–∑–æ–≤–µ—Ç onstop –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ
            }
        });

        // üîÅ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ iframe
        document.getElementById('proctorFrame').addEventListener('load', () => {
            startRecording();
        });


    </script>


{% endblock %}
